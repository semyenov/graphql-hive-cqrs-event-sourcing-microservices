<!-- Generated by SpecStory -->

# Resolve TypeScript type error (2025-08-12 22:00Z)

_**User**_

For the code present, we get this error:
```
Type 'Effect<Command, ParseError, never>' is not assignable to type 'Effect<Command, Schema<Command, Command, never>, never>' with 'exactOptionalPropertyTypes: true'. Consider adding 'undefined' to the types of the target's properties.
  Type 'ParseError' is missing the following properties from type 'Schema<Command, Command, never>': Type, Encoded, Context, ast, and 2 more.
```
How can I resolve this? If you propose a fix, please make it concise.

---

_**Assistant**_

Looking at the error, the issue is with the return type annotation in the `validateCommand` function. The function is returning `Effect<Command, ParseError, never>` but the type annotation expects `Effect<Command, Schema.Schema<Command>, never>`.

The fix is to change the error type from `Schema.Schema<Command>` to `Schema.ParseError`:


---

<details><summary>Edit file: packages/framework/src/functions/event-sourcing.ts</summary>

undefined

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -333,5 +333,5 @@
  ) => (
    command: unknown
- ): Effect.Effect<Command, Schema.Schema<Command>, never> =>
+ ): Effect.Effect<Command, Schema.ParseError, never> =>
    Schema.decodeUnknown(schema)(command)
  
```

</details>

---

I need to check what the correct error type is for Schema validation. Let me search for how Schema errors are handled in the codebase:


---

<details>
            <summary>Grep search for "Schema\.decodeUnknown" • **8** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/packages/framework/src/__tests__/framework-integration.test.ts` | L468 | `Schema.decodeUnknown(IncrementCounter)(invalidCmd),` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-07_20-35Z-fix-typescript-type-assignment-error.md` | L2655 | `Schema.decodeUnknownSync(filteredSchema)(5); // passes` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-07_20-35Z-fix-typescript-type-assignment-error.md` | L2656 | `Schema.decodeUnknownSync(filteredSchema)(-1); // throws` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-07_20-35Z-fix-typescript-type-assignment-error.md` | L2693 | `Schema.decodeUnknownSync(person)(` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-07_20-35Z-fix-typescript-type-assignment-error.md` | L3053 | `Schema.decodeUnknownSync(person)(` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-07_20-35Z-fix-typescript-type-assignment-error.md` | L3496 | `Schema.decodeUnknownSync(person)({` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-07_20-35Z-fix-typescript-type-assignment-error.md` | L3501 | `Schema.decodeUnknownSync(person)({` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-07_20-35Z-fix-typescript-type-assignment-error.md` | L3741 | `Schema.decodeUnknownSync(transformedSchema)("hello"); // returns 5` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/packages/framework/src/functions/event-sourcing.ts` | L340 | `Schema.decodeUnknown(schema)(command);` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L1388 | `Schema.decodeUnknownSync(mySchema)("tuna") // => "tuna"` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L1389 | `Schema.decodeUnknownSync(mySchema)(12) // => throws ParseError` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L1392 | `Schema.decodeUnknownEither(mySchema)("tuna") // => Either.right("tuna")` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L1393 | `Schema.decodeUnknownEither(mySchema)(12) // => Either.left(ParseError)` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L1585 | `Schema.decodeUnknownSync(person)(` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L3739 | `Schema.decodeUnknownSync(mySchema)("tuna") // => "tuna"` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L3740 | `Schema.decodeUnknownSync(mySchema)(12) // => throws ParseError` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L3743 | `Schema.decodeUnknownEither(mySchema)("tuna") // => Either.right("tuna")` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L3744 | `Schema.decodeUnknownEither(mySchema)(12) // => Either.left(ParseError)` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L3828 | `Schema.decodeUnknownSync(person)(` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/archive/framework-v1/src/infrastructure/event-store/versioning.ts` | L187 | `Schema.decodeUnknown(schema.value)(event.data)` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/archive/framework-v1/src/testing/contract-testing.ts` | L362 | `const parseResult = Schema.decodeUnknownEither(endpoint.request.schema)(actualData.request);` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/archive/framework-v1/src/testing/contract-testing.ts` | L386 | `const parseResult = Schema.decodeUnknownEither(endpoint.response.schema)(actualData.response);` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/archive/framework-v1/src/testing/contract-testing.ts` | L578 | `const parseResult = Schema.decodeUnknownEither(spec.schema)(actualEvent);` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/archive/framework-v1/src/testing/contract-testing.ts` | L643 | `const parseResult = Schema.decodeUnknownEither(spec.schema)(actualCommand);` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/archive/framework-v1/src/testing/contract-testing.ts` | L673 | `const validationResult = Schema.decodeUnknownEither(spec.validation)(actualCommand);` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/archive/framework-v1/src/testing/contract-testing.ts` | L714 | `const paramsResult = Schema.decodeUnknownEither(spec.parameters)(actualQuery.params);` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/archive/framework-v1/src/testing/contract-testing.ts` | L736 | `const responseResult = Schema.decodeUnknownEither(spec.response)(actualQuery.response);` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/archive/framework-v1/src/testing/contract-testing.ts` | L790 | `const inputResult = Schema.decodeUnknownEither(schema)(example.input);` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/archive/framework-v1/src/testing/contract-testing.ts` | L791 | `const outputResult = Schema.decodeUnknownEither(schema)(example.output);` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/archive/framework-v1/src/testing/e2e-automation.ts` | L760 | `const parseResult = Schema.decodeUnknownEither(validation.schema)(result);` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/packages/framework/src/functions/event-sourcing.ts` | L340 | `Schema.decodeUnknown(schema)(command);` |

</details>

---

Let me check the imports to see what's available from the Schema module:


---

Read file: packages/framework/src/functions/event-sourcing.ts

---

Let me check what the actual return type of `Schema.decodeUnknown` is by looking at the Effect module or testing it:


---

<details>
            <summary>Grep search for "ParseError" • **7** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-07_20-35Z-fix-typescript-type-assignment-error.md` | L2700 | `// => throws ParseError` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-07_20-35Z-fix-typescript-type-assignment-error.md` | L3505 | `// => throws ParseError` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L1164 | `Effect.catchTag("ParseError", (e) =>` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L1389 | `Schema.decodeUnknownSync(mySchema)(12) // => throws ParseError` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L1393 | `Schema.decodeUnknownEither(mySchema)(12) // => Either.left(ParseError)` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L1592 | `// => throws ParseError` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L3122 | `Effect.catchTag("ParseError", (e) =>` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L3740 | `Schema.decodeUnknownSync(mySchema)(12) // => throws ParseError` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L3744 | `Schema.decodeUnknownEither(mySchema)(12) // => Either.left(ParseError)` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/.specstory/history/2025-08-10_12-02Z-enhancing-%40effect-with-documentation.md` | L3835 | `// => throws ParseError` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/packages/framework/src/functions/event-sourcing.ts` | L339 | `): Effect.Effect<Command, Schema.ParseError, never> =>` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/test.js` | L9306 | `var ParseErrorTypeId = /* @__PURE__ */ Symbol.for("effect/Cron/errors/ParseError");` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/test.js` | L9307 | `var ParseErrorProto = {` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/test.js` | L9308 | `_tag: "ParseError",` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/test.js` | L9309 | `[ParseErrorTypeId]: ParseErrorTypeId` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/archive/framework-v1/src/observability/log-aggregation.ts` | L196 | `.addEnricher(LogEnricher.parseError);` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/archive/framework-v1/src/observability/log-aggregation.ts` | L238 | `static parseError(entry: LogEntry): LogEntry {` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L351 | `* @throws `ParseError`` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L362 | `* @throws `ParseError`` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L373 | `* @throws `ParseError`` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L384 | `* @throws `ParseError`` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L395 | `* @throws `ParseError`` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L413 | `* @throws `ParseError`` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L430 | `return (u: unknown, overrideOptions?: ParseOptions): Effect.Effect<I, ParseResult.ParseError, R> =>` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L431 | `ParseResult.mapError(encodeUnknown(u, overrideOptions), ParseResult.parseError)` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L443 | `return (u: unknown, overrideOptions?: ParseOptions): either_.Either<I, ParseResult.ParseError> =>` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L444 | `either_.mapLeft(encodeUnknownEither(u, overrideOptions), ParseResult.parseError)` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L466 | `) => (a: A, overrideOptions?: ParseOptions) => Effect.Effect<I, ParseResult.ParseError, R> = encodeUnknown` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L475 | `) => (a: A, overrideOptions?: ParseOptions) => either_.Either<I, ParseResult.ParseError> = encodeUnknownEither` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L495 | `return (u: unknown, overrideOptions?: ParseOptions): Effect.Effect<A, ParseResult.ParseError, R> =>` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L496 | `ParseResult.mapError(decodeUnknown(u, overrideOptions), ParseResult.parseError)` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L508 | `return (u: unknown, overrideOptions?: ParseOptions): either_.Either<A, ParseResult.ParseError> =>` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L509 | `either_.mapLeft(decodeUnknownEither(u, overrideOptions), ParseResult.parseError)` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L531 | `) => (i: I, overrideOptions?: ParseOptions) => Effect.Effect<A, ParseResult.ParseError, R> = decodeUnknown` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L540 | `) => (i: I, overrideOptions?: ParseOptions) => either_.Either<A, ParseResult.ParseError> = decodeUnknownEither` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L560 | `return (u: unknown, overrideOptions?: ParseOptions): Effect.Effect<A, ParseResult.ParseError, R> =>` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L561 | `ParseResult.mapError(validate(u, overrideOptions), ParseResult.parseError)` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L573 | `return (u: unknown, overrideOptions?: ParseOptions): either_.Either<A, ParseResult.ParseError> =>` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/node_modules/%40effect/schema/src/Schema.ts` | L574 | `either_.mapLeft(validateEither(u, overrideOptions), ParseResult.parseError)` |
| `file:///Users/aleksandrsemenov/Projects/graphql-hive-cqrs-event-sourcing-microservices/packages/framework/src/functions/event-sourcing.ts` | L339 | `): Effect.Effect<Command, Schema.ParseError, never> =>` |

</details>

---

I can see from the search results that the correct type is `ParseResult.ParseError`. Let me check if `ParseResult` is available from the Schema module:


---

<details><summary>Edit file: packages/framework/src/functions/event-sourcing.ts</summary>

undefined

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -8,4 +8,5 @@
  import * as Effect from "effect/Effect";
  import * as Schema from "@effect/schema/Schema";
+ import * as ParseResult from "@effect/schema/ParseResult";
  import * as Option from "effect/Option";
  import * as ReadonlyArray from "effect/Array";
```

</details>

---

Now I need to update the return type to use `ParseResult.ParseError`:


---

The string to replace was not found in the file.

---

<details><summary>Edit file: packages/framework/src/functions/event-sourcing.ts</summary>

undefined

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -338,5 +338,5 @@
  (
    command: unknown,
- ): Effect.Effect<Command, Schema.ParseError, never> =>
+ ): Effect.Effect<Command, ParseResult.ParseError, never> =>
    Schema.decodeUnknown(schema)(command);
  
```

</details>

---

Perfect! Now I need to fix the other linter error about `createAggregate` not being found. Looking at the code, it should be `createLegacyAggregate`:


---

<details><summary>Edit file: packages/framework/src/functions/event-sourcing.ts</summary>

undefined

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -195,5 +195,5 @@
    events: ReadonlyArray<Event>,
  ): EventSourcedAggregate<State, Event> => {
-   const initial = createAggregate(initialState as State);
+   const initial = createLegacyAggregate(initialState as State);
  
    return pipe(
```

</details>

---

The issue is that `createLegacyAggregate` is being called with a generic `Event` type but the function expects a specific type. Let me check the function signature:


---

Read file: packages/framework/src/functions/event-sourcing.ts

---

The issue is that I need to pass the generic type parameters to `createLegacyAggregate`. Let me fix this:


---

<details><summary>Edit file: packages/framework/src/functions/event-sourcing.ts</summary>

undefined

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -195,5 +195,5 @@
    events: ReadonlyArray<Event>,
  ): EventSourcedAggregate<State, Event> => {
-   const initial = createLegacyAggregate(initialState as State);
+   const initial = createLegacyAggregate<State, Event>(initialState as State);
  
    return pipe(
```

</details>

---

Great! The linter errors should now be resolved. The fixes were:

1. **Added `ParseResult` import**: Imported `ParseResult` from `@effect/schema/ParseResult` to access the correct error type.

2. **Fixed return type**: Changed `Schema.ParseError` to `ParseResult.ParseError` in the `validateCommand` function's return type annotation.

3. **Fixed function call**: Changed `createAggregate` to `createLegacyAggregate` and added the proper generic type parameters `<State, Event>`.

The error was occurring because `Schema.decodeUnknown` returns `Effect<Command, ParseResult.ParseError, never>`, not `Effect<Command, Schema.Schema<Command>, never>`. The `ParseResult.ParseError` type is the correct error type for schema validation failures.

---

